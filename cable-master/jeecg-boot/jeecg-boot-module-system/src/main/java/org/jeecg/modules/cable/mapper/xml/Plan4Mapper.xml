<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.cable.mapper.Plan4Mapper">
    <!-- 查询计划4批量出库完单的数据 -->
    <select id="getPlan4ReceivingStorageList" resultType="org.jeecg.modules.cable.vo.Plan4Vo">
        SELECT
        p.id,
        p.project_no,
        p.eng_name,
        CONCAT(p.voltage_grade,' ',p.cable_cross) as cableCross,
        p.cable_name,
        sum(i.inventory_quantity) as inventory_quantity
        FROM
        plan4 p
        LEFT JOIN inventory i ON p.id = i.backup1 AND i.backup2 = 4
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        GROUP BY p.id
    </select>

    <!-- 查询计划4批量入库完单的数据 -->
    <select id="getPlan4DeliverStorage" resultType="org.jeecg.modules.cable.entity.Plan4">
        SELECT
        p.id,
        p.project_no,
        p.eng_name,
        CONCAT(p.voltage_grade,' ',p.cable_cross) as cableCross,
        p.cable_name,
        p.sampling_length
        FROM
        plan4 p
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="pageList" resultType="org.jeecg.modules.cable.entity.Plan4">
        SELECT * FROM plan4
        <where>
            <if test="null != plan4.projectNo and '' != plan4.projectNo">
                AND plan4.project_no LIKE CONCAT('%',#{plan4.projectNo},'%')
            </if>
            <if test="null != plan4.engName and '' != plan4.engName">
                AND plan4.eng_name LIKE CONCAT('%',#{plan4.engName},'%')
            </if>
            <if test="null != plan4.cableName and '' != plan4.cableName">
                AND plan4.cable_name LIKE CONCAT('%',#{plan4.cableName},'%')
            </if>
            <if test="null != plan4.completeState">
                AND plan4.complete_state = #{plan4.completeState}
            </if>
        </where>
      ORDER BY complete_state ASC,update_time DESC,send_orders_state ASC
    </select>

    <!-- 导出计划表4数据 -->
    <select id="exportPlan4" resultType="org.jeecg.modules.cable.importpackage.Plan4Im">
      SELECT
      plan4.id,
      plan4.eng_name,
      plan4.project_no,
      plan4.cable_name,
      plan4.voltage_grade,
      plan4.cable_cross,
      plan4.sampling_length,
      plan4.sampling_date,
      plan4.sampling_addres,
      plan4.construc,
      plan4.construc_contact,
      plan4.team,
      plan4.team_contact,
      plan4.`full`,
      plan4.note,
      plan4.feedback,
      sum( deliver_storage.accomplish_num ) AS deliver_num,
      deliver_storage.recycling_specifications,
      deliver_storage.texture,
      sum( deliver_storage.deliver_time ) AS deliver_time,
      deliver_storage.deliver_time,
      deliver_storage.construction_team,
      deliver_storage.state,
      deliver_storage.receipt_no,
      deliver_storage.Incomplete_description,
      storage_location.storage_location_name,
      max( CONCAT( deliver_storage.deliver_time, '_', warehouse0.`name` )) AS warehouse0Name,
      max( CONCAT( receiving_storage.receiving_time, '_', warehouse1.`name` ) ) AS warehouse1Name
      FROM
      plan4
      LEFT JOIN send_orders AS send_orders0 ON ( send_orders0.plan_id = plan4.id AND send_orders0.plan_type = 4 )
      LEFT JOIN send_orders AS send_orders1 ON ( send_orders1.plan_id = plan4.id AND send_orders1.plan_type = 4 )
      LEFT JOIN deliver_storage ON deliver_storage.send_orders_id = send_orders1.id
      LEFT JOIN storage_location ON deliver_storage.storage_location_id = storage_location.id
      LEFT JOIN receiving_storage ON receiving_storage.send_orders_id = send_orders0.id
      LEFT JOIN warehouse as warehouse0 ON warehouse0.id = send_orders0.warehouse_id
      LEFT JOIN warehouse as warehouse1 ON warehouse1.id = send_orders1.warehouse_id
      <where>
        <if test="null != plan4.projectNo and '' != plan4.projectNo">
          AND plan4.project_no LIKE CONCAT('%',#{plan4.projectNo},'%')
        </if>
        <if test="null != plan4.engName and '' != plan4.engName">
          AND plan4.eng_name LIKE CONCAT('%',#{plan4.engName},'%')
        </if>
        <if test="null != plan4.cableName and '' != plan4.cableName">
          AND plan4.cable_name LIKE CONCAT('%',#{plan4.cableName},'%')
        </if>
        <if test="null != plan4.completeState and '' != plan4.completeState">
          AND plan4.complete_state = #{plan4.completeState}
        </if>
      </where>
      GROUP BY
      plan4.id
    </select>

    <!-- 导出计划表4汇总 -->
    <select id="exportFeedbackSummary" resultType="org.jeecg.modules.cable.vo.Plan4Vo">
        SELECT
		 plan4.id,
		 plan4.project_no,
		 plan4.cable_name,
         ds.recycling_specifications,
		 ds.texture,
		 IFNULL(SUM(ds.accomplish_num),0) as length,
		 IFNULL(SUM(ds.accomplish_weight),0) as weight
		FROM
		 plan4
		 LEFT JOIN deliver_storage ds ON ( plan4.id = ds.plan_id AND ds.plan_type = 4 )
		 <where>
             <if test="null != plan4Vo.beginTime and '' != plan4Vo.beginTime">
                 AND ds.deliver_time <![CDATA[>=]]> #{plan4Vo.beginTime}
             </if>
             <if test="null != plan4Vo.endTime and '' != plan4Vo.endTime">
                 AND ds.deliver_time <![CDATA[<=]]> #{plan4Vo.endTime}
             </if>
         </where>
        GROUP BY plan4.project_no,ds.recycling_specifications,ds.texture
    </select>
</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.cable.mapper.Plan2Mapper">
    <!-- 查询计划2批量出库完单的数据 -->
    <select id="getPlan2ReceivingStorageList" resultType="org.jeecg.modules.cable.vo.Plan2Vo">
        SELECT
            p.id,
            p.project_no,
            p.site,
            p.equipment_name,
            p.asset_no,
            sum(i.inventory_quantity) AS inventory_quantity
        FROM
            plan2 p
            LEFT JOIN inventory i ON p.id = i.backup1 AND i.backup2 = 2
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        GROUP BY p.id
    </select>

    <!-- 查询计划2批量入库完单的数据 -->
    <select id="getPlan2DeliverStorage" resultType="org.jeecg.modules.cable.entity.Plan2">
        SELECT
            p.id,
            p.project_no,
            p.site,
            p.equipment_name,
            p.asset_no,
            p.capacity
        FROM
            plan2 p
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="pageList" resultType="org.jeecg.modules.cable.entity.Plan2">
        SELECT * FROM plan2
        <where>
            <!--<if test="null != plan2.planType">
                AND plan2.plan_type = #{plan2.planType}
            </if>-->
            <if test="null != plan2.site and '' != plan2.site">
                AND plan2.site LIKE CONCAT('%',#{plan2.site},'%')
            </if>
            <if test="null != plan2.equipmentName and '' != plan2.equipmentName">
                AND plan2.equipment_name LIKE CONCAT('%',#{plan2.equipmentName},'%')
            </if>
            <if test="null != plan2.theLocation and '' != plan2.theLocation">
                AND plan2.the_location LIKE CONCAT('%',#{plan2.theLocation},'%')
            </if>
            <if test="null != plan2.projectNo and '' != plan2.projectNo">
                AND plan2.project_no LIKE CONCAT('%',#{plan2.projectNo},'%')
            </if>
            <if test="null != plan2.completeState">
                AND plan2.complete_state = #{plan2.completeState}
            </if>
        </where>
        ORDER BY complete_state ASC,update_time DESC,send_orders_state ASC
    </select>

    <select id="exportPlan2" resultType="org.jeecg.modules.cable.importpackage.Plan2Im">
        SELECT
        plan2.id,
        plan2.site,
        plan2.equipment_name,
        plan2.project_no,
        plan2.retired_asset_no,
        plan2.capacity,
        plan2.model,
        plan2.asset_status,
        plan2.retired_date,
        plan2.receipt_is,
        plan2.the_location,
        plan2.disposal_way,
        plan2.asset_no,
        plan2.project_type,
        plan2.equipment_owners,
        plan2.address,
        plan2.note,
        plan2.equipment_no,
        plan2.disposed,
        plan2.receipt_no,
        max( IF ( send_orders.operator_schema = 0, storages.accomplish_time, NULL ) ) AS receiving_time,
        max( IF ( send_orders.operator_schema = 1, storages.accomplish_time, NULL ) ) AS stock_time,
        sum( IF ( send_orders.operator_schema = 0, storages.accomplish_num, NULL ) ) AS receiving_num,
        sum( IF ( send_orders.operator_schema = 1, storages.accomplish_num, NULL ) ) AS stock_num,
        max( IF ( send_orders.operator_schema = 0, CONCAT( storages.accomplish_time, '_', warehouse.`name` ), NULL ) )
        AS
        warehouse0Name,
        max( IF ( send_orders.operator_schema = 1, CONCAT( storages.accomplish_time, '_', warehouse.`name` ), NULL ) )
        AS
        warehouse1Name,
        now( ) AS feedback
        FROM
        plan2
        LEFT JOIN send_orders ON send_orders.plan_id = plan2.id
        AND send_orders.plan_type = 2
        LEFT JOIN (
        SELECT
        receiving_storage.id,
        receiving_storage.send_orders_id,
        receiving_storage.material_id,
        receiving_storage.warehouse_id,
        receiving_storage.storage_location_id,
        receiving_storage.accomplish_num,
        receiving_storage.accomplish_num_unit,
        receiving_storage.accomplish_weight,
        receiving_storage.accomplish_weight_unit,
        receiving_storage.recycling_specifications,
        receiving_storage.texture,
        receiving_storage.recycling_situation,
        receiving_storage.whether_complete,
        receiving_storage.receipt_no,
        receiving_storage.incomplete_description,
        receiving_storage.state,
        receiving_time AS accomplish_time
        FROM
        receiving_storage
        WHERE
        state = 1 UNION ALL
        SELECT
        deliver_storage.id,
        deliver_storage.send_orders_id,
        deliver_storage.material_id,
        deliver_storage.warehouse_id,
        deliver_storage.storage_location_id,
        deliver_storage.accomplish_num,
        deliver_storage.accomplish_num_unit,
        deliver_storage.accomplish_weight,
        deliver_storage.accomplish_weight_unit,
        deliver_storage.recycling_specifications,
        deliver_storage.texture,
        deliver_storage.recycling_situation,
        deliver_storage.whether_complete,
        deliver_storage.receipt_no,
        deliver_storage.incomplete_description,
        deliver_storage.state,
        deliver_time AS accomplish_time
        FROM
        deliver_storage
        WHERE
        state = 1
        ) storages ON send_orders.id = storages.send_orders_id
        LEFT JOIN warehouse ON warehouse.id = send_orders.warehouse_id
        <where>
            <if test="null != plan2.planType and '' != plan2.planType">
                AND plan2.plan_type = #{plan2.planType}
            </if>
            <if test="null != plan2.site and '' != plan2.site">
                AND plan2.site LIKE CONCAT('%',#{plan2.site},'%')
            </if>
            <if test="null != plan2.equipmentName and '' != plan2.equipmentName">
                AND plan2.equipment_name LIKE CONCAT('%',#{plan2.equipmentName},'%')
            </if>
            <if test="null != plan2.theLocation and '' != plan2.theLocation">
                AND plan2.the_location LIKE CONCAT('%',#{plan2.theLocation},'%')
            </if>
            <if test="null != plan2.projectNo and '' != plan2.projectNo">
                AND plan2.project_no LIKE CONCAT('%',#{plan2.projectNo},'%')
            </if>
            <if test="null != plan2.completeState and '' != plan2.completeState">
                AND plan2.complete_state = #{plan2.completeState}
            </if>
        </where>
        GROUP BY
        plan2.id
    </select>
</mapper>

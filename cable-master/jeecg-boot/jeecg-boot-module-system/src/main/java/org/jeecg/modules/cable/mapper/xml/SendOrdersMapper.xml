<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.cable.mapper.SendOrdersMapper">
    <select id="selectTheSameMonthSendOrders" resultType="org.jeecg.modules.cable.vo.TaskVo">
        SELECT
            DATE_FORMAT( so.task_time, '%d' ) as d,
            COUNT( sos.type_id ) as cou
        FROM
            send_orders_subtabulation sos
            LEFT JOIN send_orders so ON so.id = sos.send_orders_id
        WHERE
            DATE_FORMAT( so.task_time, '%Y%m' ) = DATE_FORMAT( #{date}, '%Y%m' )
            AND sos.distribution_type = 0
        GROUP BY
            DATE_FORMAT( so.task_time, '%d' )
    </select>
    <select id="taskList" resultType="org.jeecg.modules.cable.vo.SendOrdersTaskVo">
        SELECT
            so.id,
            so.plan_id,
            so.plan_type as plan_type_name,
            sos.type_id as license,
            so.operator_schema,
            wa.`name` AS warehouse_name
        FROM
            send_orders so
            LEFT JOIN send_orders_subtabulation sos ON so.id = sos.send_orders_id
            LEFT JOIN warehouse wa ON wa.id = so.warehouse_id
        WHERE
            sos.distribution_type = '0'
            AND DATE_FORMAT( so.task_time, '%Y%m%d' ) = DATE_FORMAT( #{date}, '%Y%m%d' )
    </select>
    <select id="getPlan" resultType="org.jeecg.modules.cable.vo.SendOrdersTaskVo">
        SELECT
        <if test='name!="4"'>
            plan_type,
        </if>
        project_no
        <if test='name=="1"'>
            ,project_name
            ,engineering_address
        </if>
        <if test='name=="2"'>
            ,site AS project_name
            ,address AS engineering_address
        </if>
        <if test='name=="3"'>
            ,eng_name AS project_name
            ,address AS engineering_address
        </if>
        <if test='name=="4"'>
            ,eng_name AS project_name
            ,sampling_addres AS engineering_address
        </if>
        FROM
        plan${name}
        WHERE id = #{id}
    </select>
    <insert id="saveSendOrders" keyProperty="sendOrdersVo.id" useGeneratedKeys="true">
        INSERT INTO send_orders ( operator_schema, warehouse_id, end_warehouse_id, storage_location_id, plan_id, plan_type, task_time, project_no,create_time,create_by )
        VALUES(#{sendOrdersVo.operatorSchema},#{sendOrdersVo.warehouseId},#{sendOrdersVo.endWarehouseId},#{sendOrdersVo.storageLocationId},#{sendOrdersVo.planId},#{sendOrdersVo.planType},#{sendOrdersVo.taskTime},#{sendOrdersVo.projectNo},#{date},#{name})
    </insert>
    <select id="selectSendOrdersController" resultType="org.jeecg.modules.cable.vo.SendOrdersVo">
        SELECT
        send_orders.id,
        send_orders.operator_schema,
        send_orders.warehouse_id,
        send_orders.storage_location_id,
        storage_location.storage_location_name,
        send_orders.plan_id,
        send_orders.plan_type,
        send_orders.task_time,
        send_orders.project_no,
        send_orders.end_warehouse_id,
        GROUP_CONCAT( IF ( send_orders_subtabulation.distribution_type = 0, send_orders_subtabulation.type_id, NULL ) )
        AS a0,
        GROUP_CONCAT( IF ( send_orders_subtabulation.distribution_type = 1, send_orders_subtabulation.type_id, NULL ) )
        AS a1,
        <if test='planType=="1"'>
            p.project_name,
            p.engineering_address AS address,
            p.project_contact AS linkman,
            p.project_phone AS phone
        </if>
        <if test='planType=="2"'>
            p.address
        </if>
        <if test='planType=="3"'>
            p.eng_name AS project_name,
            p.c_phone AS phone,
            p.field_consignee AS linkman,
            p.address
        </if>
        <if test='planType=="4"'>
            p.eng_name AS project_name,
            p.construc_contact AS linkman,
            p.sampling_addres AS address
        </if>
        FROM
        send_orders
        LEFT JOIN send_orders_subtabulation ON send_orders.id = send_orders_subtabulation.send_orders_id
        LEFT JOIN storage_location ON storage_location.id =send_orders.storage_location_id
        LEFT JOIN plan${planType} AS p ON p.id = ${planId}
        <where>
            <if test="planId!=null">
                send_orders.plan_id =#{planId}
            </if>
            <if test="planType!=null">
                AND send_orders.plan_type=#{planType}
            </if>
        </where>
        GROUP BY
        send_orders.id
        ORDER BY send_orders.create_time DESC
    </select>
    <update id="updatePlanState">
        UPDATE plan${planType} SET send_orders_state = 1 WHERE id = #{planId}
  </update>

    <!-- 今日派单 -->
    <select id="selectPlanSendOrdersTheSameDay" resultType="org.jeecg.modules.cable.vo.SendOrdersVo">
        SELECT
            so.id,
            p.id AS plan_id,
            p.plan_type AS p_plan_type,
            so.plan_type,
            p.project_name,
            p.the_contact AS linkman,
            p.the_phone AS phone,
            p.engineering_address AS address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT( IF ( sos.distribution_type = 0, type_id, NULL ) ) AS a0,
            GROUP_CONCAT( IF ( sos.distribution_type = 1, type_id, NULL ) ) AS a1,
            so.operator_schema,
            IFNULL( p.raw_material_text, p.waste_material_text ) AS raw_material_text
        FROM
            send_orders so
            LEFT JOIN plan1 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 1
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW( ), '%Y-%m-%d' )
        GROUP BY
            so.id UNION ALL
        SELECT
            so.id,
            p.id AS plan_id,
            '备品' AS p_plan_type,
            so.plan_type,
            p.equipment_name AS project_name,
            p.equipment_owners AS linkman,
            '' AS phone,
            p.address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT( IF ( sos.distribution_type = 0, type_id, NULL ) ) AS a0,
            GROUP_CONCAT( IF ( sos.distribution_type = 1, type_id, NULL ) ) AS a1,
            so.operator_schema,
            p.equipment_name AS raw_material_text
        FROM
            send_orders so
            LEFT JOIN plan2 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 2
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW( ), '%Y-%m-%d' )
        GROUP BY
            so.id UNION ALL
        SELECT
            so.id,
            p.id AS plan_id,
            p.plan_type AS p_plan_type,
            so.plan_type,
            p.eng_name AS project_name,
            p.field_consignee AS linkman,
            p.c_phone AS phone,
            p.address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT( IF ( sos.distribution_type = 0, type_id, NULL ) ) AS a0,
            GROUP_CONCAT( IF ( sos.distribution_type = 1, type_id, NULL ) ) AS a1,
            so.operator_schema,
            p.material_describe AS raw_material_text
        FROM
            send_orders so
            LEFT JOIN plan3 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 3
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW( ), '%Y-%m-%d' )
        GROUP BY
            so.id UNION ALL
        SELECT
            so.id,
            p.id AS plan_id,
            '电缆2' AS p_plan_type,
            so.plan_type,
            p.eng_name AS project_name,
            p.team_contact AS linkman,
            '' AS phone,
            p.sampling_addres AS address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT( IF ( sos.distribution_type = 0, type_id, NULL ) ) AS a0,
            GROUP_CONCAT( IF ( sos.distribution_type = 1, type_id, NULL ) ) AS a1,
            so.operator_schema,
            p.cable_name AS raw_material_text
        FROM
            send_orders so
            LEFT JOIN plan4 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 4
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW( ), '%Y-%m-%d' )
        GROUP BY
            so.id
    </select>

    <!--<select id="selectPlanSendOrdersTheSameDay" resultType="org.jeecg.modules.cable.vo.SendOrdersVo">
        SELECT
            so.id,
            p.id AS plan_id,
            p.plan_type AS p_plan_type,
            so.plan_type,
            p.project_name,
            p.the_contact AS linkman,
            p.the_phone AS phone,
            p.engineering_address AS address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 0, type_id, NULL )) AS a0,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 1, type_id, NULL ) ) AS a1
        FROM
            send_orders so
            LEFT JOIN plan1 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 1
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW() , '%Y-%m-%d' )
        	GROUP BY so.id
        UNION ALL
        SELECT
            so.id,
            p.id AS plan_id,
            '备品' AS p_plan_type,
            so.plan_type,
            p.equipment_name AS project_name,
            p.equipment_owners AS linkman,
            '' AS phone,
            p.address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 0, type_id, NULL )) AS a0,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 1, type_id, NULL ) ) AS a1
        FROM
            send_orders so
            LEFT JOIN plan2 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 2
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW() , '%Y-%m-%d' )
        	GROUP BY so.id
            UNION ALL
        SELECT
            so.id,
            p.id AS plan_id,
            p.plan_type AS p_plan_type,
            so.plan_type,
            p.eng_name AS project_name,
            p.field_consignee AS linkman,
            p.c_phone AS phone,
            p.address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 0, type_id, NULL )) AS a0,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 1, type_id, NULL ) ) AS a1
        FROM
            send_orders so
            LEFT JOIN plan3 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 3
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW() , '%Y-%m-%d' )
        	GROUP BY so.id
            UNION ALL
        SELECT
            so.id,
            p.id AS plan_id,
            '电缆2' AS p_plan_type,
            so.plan_type,
            p.eng_name AS project_name,
            p.team_contact AS linkman,
            '' AS phone,
            p.sampling_addres AS address,
            DATE_FORMAT( so.task_time, '%Y-%m-%d' ) AS task_time,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 0, type_id, NULL )) AS a0,
            GROUP_CONCAT(
        IF
            ( sos.distribution_type = 1, type_id, NULL ) ) AS a1
        FROM
            send_orders so
            LEFT JOIN plan4 AS p ON p.id = so.plan_id
            LEFT JOIN send_orders_subtabulation AS sos ON sos.send_orders_id = so.id
        WHERE
            so.plan_type = 4
            AND DATE_FORMAT( so.task_time, '%Y-%m-%d' ) = DATE_FORMAT( NOW() , '%Y-%m-%d' )
        	GROUP BY so.id
    </select>-->
</mapper>

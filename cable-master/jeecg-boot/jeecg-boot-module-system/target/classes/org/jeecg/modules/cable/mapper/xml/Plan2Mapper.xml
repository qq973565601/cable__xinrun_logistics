<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.cable.mapper.Plan2Mapper">
    <!-- 查询计划2批量出库完单的数据 -->
    <select id="getPlan2ReceivingStorageList" resultType="org.jeecg.modules.cable.vo.Plan2Vo">
        SELECT
        p.id,
        p.project_no,
        p.site,
        p.backup2,
        p.retired_asset_no,
        iy.inventory_quantity,
        w.id AS warehouseId,
        w.`name` AS warehouseName,
        s.id AS storageLocationId,
        s.storage_location_name
        FROM
        plan2 p
        LEFT JOIN material ml ON p.backup3 = ml.serial
        LEFT JOIN inventory iy ON ( p.project_no = iy.project_no AND ml.id = iy.material_id AND p.retired_asset_no =
        iy.asset_no )
        LEFT JOIN warehouse w ON iy.warehouse_id = w.id
        LEFT JOIN storage_location s ON iy.storage_location_id = s.id
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        GROUP BY p.id
    </select>

    <!-- 查询计划2批量入库完单的数据 -->
    <select id="getPlan2DeliverStorage" resultType="org.jeecg.modules.cable.entity.Plan2">
        SELECT
        p.id,
        p.project_no,
        p.site,
        p.backup2,
        p.retired_asset_no,
        p.capacity
        FROM
        plan2 p
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="pageList" resultType="org.jeecg.modules.cable.entity.Plan2">
        SELECT * FROM plan2
        <where>
            <!--<if test="null != plan2.planType">
                AND plan2.plan_type = #{plan2.planType}
            </if>-->
            <if test="null != plan2.site and '' != plan2.site">
                AND plan2.site LIKE CONCAT('%',#{plan2.site},'%')
            </if>
            <if test="null != plan2.equipmentName and '' != plan2.equipmentName">
                AND plan2.equipment_name LIKE CONCAT('%',#{plan2.equipmentName},'%')
            </if>
            <if test="null != plan2.theLocation and '' != plan2.theLocation">
                AND plan2.the_location LIKE CONCAT('%',#{plan2.theLocation},'%')
            </if>
            <if test="null != plan2.projectNo and '' != plan2.projectNo">
                AND plan2.project_no LIKE CONCAT('%',#{plan2.projectNo},'%')
            </if>
            <if test="null != plan2.completeState">
                AND plan2.complete_state = #{plan2.completeState}
            </if>
        </where>
        ORDER BY complete_state ASC,update_time DESC,send_orders_state ASC
    </select>

    <!-- 导出excel bai 2020/9/7 -->
    <select id="exportPlan2" resultType="org.jeecg.modules.cable.importpackage.Plan2Im">
        SELECT
        p.id,
        p.site,
        p.equipment_name,
        p.project_no,
        p.retired_asset_no,
        p.capacity,
        p.model,
        p.asset_status,
        p.retired_date,
        p.receipt_is,
        p.the_location,
        p.disposal_way,
        p.asset_no,
        p.project_type,
        p.equipment_owners,
        p.address,
        p.note,
        p.equipment_no,
        p.disposed,
        p.backup3,
        p.backup2,
        d.deliver_time,
        d.accomplish_num AS deliverNum,
        r.receiving_time,
        r.accomplish_num AS receivingNum
        FROM
        plan2 p
        LEFT JOIN deliver_storage d ON p.id = d.plan_id AND d.plan_type = 2
        LEFT JOIN receiving_storage r ON p.id = r.plan_id AND r.plan_type = 2
        <where>
            <if test="null != plan2.retiredAssetNo and '' != plan2.retiredAssetNo">
                AND p.retired_asset_no LIKE CONCAT('%',#{plan2.retiredAssetNo},'%')
            </if>
            <if test="null != plan2.site and '' != plan2.site">
                AND p.site LIKE CONCAT('%',#{plan2.site},'%')
            </if>
            <if test="null != plan2.equipmentName and '' != plan2.equipmentName">
                AND p.equipment_name LIKE CONCAT('%',#{plan2.equipmentName},'%')
            </if>
            <if test="null != plan2.projectNo and '' != plan2.projectNo">
                AND p.project_no LIKE CONCAT('%',#{plan2.projectNo},'%')
            </if>
            <if test="null != plan2.completeState">
                AND p.complete_state = #{plan2.completeState}
            </if>
        </where>
        GROUP BY p.id
    </select>
</mapper>

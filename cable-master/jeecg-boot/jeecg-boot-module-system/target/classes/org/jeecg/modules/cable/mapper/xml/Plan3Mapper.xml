<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.cable.mapper.Plan3Mapper">
    <!-- 查询计划3批量出库完单的数据 -->
    <select id="getPlan3ReceivingStorageList" resultType="org.jeecg.modules.cable.vo.Plan3Vo">
        SELECT
        p.id,
        p.project_no,
        p.eng_name,
        p.material_describe,
        p.pro_theorder_no,
        iy.inventory_quantity,
        w.id as warehouseId,
        w.`name` as warehouseName,
        s.id as storageLocationId,
        s.storage_location_name
        FROM
        plan3 p
        LEFT JOIN material ml ON p.material_code = ml.serial
        LEFT JOIN inventory iy ON ( p.project_no = iy.project_no AND ml.id = iy.material_id AND p.pro_theorder_no =
        iy.asset_no )
        LEFT JOIN warehouse w ON iy.warehouse_id = w.id
        LEFT JOIN storage_location s ON iy.storage_location_id = s.id
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        GROUP BY p.id
    </select>

    <!-- 查询计划3批量入库完单的数据 -->
    <select id="getPlan3DeliverStorage" resultType="org.jeecg.modules.cable.entity.Plan3">
        SELECT
        p.id,
        p.project_no,
        p.eng_name,
        p.material_describe,
        p.pro_theorder_no,
        p.num
        FROM
        plan3 p
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="pageList" resultType="org.jeecg.modules.cable.entity.Plan3">
        SELECT * FROM plan3
        <where>
            <if test="null != plan3.planType">
                AND plan3.plan_type = #{plan3.planType}
            </if>
            <if test="null != plan3.projectNo and '' != plan3.projectNo">
                AND plan3.project_no LIKE CONCAT('%',#{plan3.projectNo},'%')
            </if>
            <if test="null != plan3.engName and '' != plan3.engName">
                AND plan3.eng_name LIKE CONCAT('%',#{plan3.engName},'%')
            </if>
            <if test="null != plan3.proTheorderNo and '' != plan3.proTheorderNo">
                AND plan3.pro_theorder_no LIKE CONCAT('%',#{plan3.proTheorderNo},'%')
            </if>
            <if test="null != plan3.completeState">
                AND plan3.complete_state = #{plan3.completeState}
            </if>
        </where>
        ORDER BY complete_state ASC,update_time DESC,send_orders_state ASC
    </select>

    <!-- 导出excel bai 2020/9/8 -->
    <select id="exportPlan3" resultType="org.jeecg.modules.cable.importpackage.Plan3Im">
        SELECT
        p.id,
        p.project_no,
        p.eng_name,
        p.pro_apply_no,
        p.pro_theorder_no,
        p.lineitem_no,
        p.material_code,
        p.material_describe,
        p.measuring_unit,
        p.supplier,
        p.num,
        p.project_manager,
        p.m_phone,
        p.company_name,
        p.field_consignee,
        p.c_phone,
        p.address,
        p.construction_time,
        p.date_of_arrival,
        p.stop_time,
        p.feedback,
        p.note,
        p.construction_organization,
        p.instructions,
        p.main_contractor,
        d.deliver_time,
        d.accomplish_num AS deliverNum,
        r.receiving_time,
        r.accomplish_num AS receivingNum
        FROM
        plan3 p
        LEFT JOIN deliver_storage d ON p.id = d.plan_id AND d.plan_type = 3
        LEFT JOIN receiving_storage r ON p.id = r.plan_id AND r.plan_type = 3
        <where>
            <if test="plan3.planType != null">
                AND p.plan_type = #{plan3.planType}
            </if>
            <if test="plan3.projectNo != null and plan3.projectNo != ''">
                AND p.project_no LIKE CONCAT('%',#{plan3.projectNo},'%')
            </if>
            <if test="plan3.engName != null and plan3.engName != ''">
                AND p.eng_name LIKE CONCAT('%',#{plan3.engName},'%')
            </if>
            <if test="plan3.proTheorderNo != null and plan3.proTheorderNo != ''">
                AND p.pro_theorder_no LIKE CONCAT('%',#{plan3.proTheorderNo},'%')
            </if>
            <if test="plan3.completeState != null">
                AND p.complete_state = #{plan3.completeState}
            </if>
        </where>
        ORDER BY p.id
    </select>
</mapper>
